generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  FREELANCER
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum EscrowStatus {
  UNFUNDED
  FUNDED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum DisputeStatus {
  OPEN
  VOTING
  RESOLVED
  APPEALED
}

enum VoteChoice {
  CLIENT
  FREELANCER
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  email         String?  @unique
  username      String   @unique
  password      String?
  bio           String?
  avatarUrl     String?
  role                   UserRole  @default(FREELANCER)
  emailVerified          Boolean   @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpiry    DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  clientJobs     Job[]         @relation("ClientJobs")
  freelancerJobs Job[]         @relation("FreelancerJobs")
  applications   Application[]
  sentMessages   Message[]     @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")
  reviewsGiven   Review[]      @relation("ReviewsGiven")
  reviewsReceived Review[]     @relation("ReviewsReceived")
  skills          String[]
  initiatedDisputes Dispute[]  @relation("InitiatedDisputes")
  clientDisputes    Dispute[]  @relation("ClientDisputes")
  freelancerDisputes Dispute[] @relation("FreelancerDisputes")
  disputeVotes      DisputeVote[]
}

model Job {
  id           String    @id @default(cuid())
  title        String
  description  String
  budget       Float
  category     String
  status       JobStatus @default(OPEN)
  clientId     String
  freelancerId String?
  contractJobId String?   @unique
  escrowStatus  EscrowStatus @default(UNFUNDED)
  skills       String[]
  deadline     DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  client       User          @relation("ClientJobs", fields: [clientId], references: [id])
  freelancer   User?         @relation("FreelancerJobs", fields: [freelancerId], references: [id])
  milestones   Milestone[]
  applications Application[]
  messages     Message[]
  reviews      Review[]
  disputes     Dispute[]
}

model Milestone {
  id          String          @id @default(cuid())
  jobId       String
  title       String
  description String
  amount      Float
  status      MilestoneStatus @default(PENDING)
  order       Int
  onChainIndex Int?
  contractDeadline DateTime?
  dueDate     DateTime?
  createdAt   DateTime        @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

model Application {
  id             String            @id @default(cuid())
  jobId             String
  freelancerId      String
  proposal          String
  bidAmount         Float
  estimatedDuration String
  status            ApplicationStatus @default(PENDING)
  createdAt      DateTime          @default(now())

  job        Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  freelancer User @relation(fields: [freelancerId], references: [id])

  @@unique([jobId, freelancerId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  jobId      String?
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])
  job      Job? @relation(fields: [jobId], references: [id])
}

model Review {
  id         String   @id @default(cuid())
  jobId      String
  reviewerId String
  revieweeId String
  rating     Int
  comment    String
  createdAt  DateTime @default(now())

  job      Job  @relation(fields: [jobId], references: [id])
  reviewer User @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewee User @relation("ReviewsReceived", fields: [revieweeId], references: [id])

  @@unique([jobId, reviewerId])
}

model Dispute {
  id                String        @id @default(cuid())
  jobId             String
  clientId          String
  freelancerId      String
  initiatorId       String
  reason            String
  status            DisputeStatus @default(OPEN)
  onChainDisputeId  String?       @unique
  resolution        String?
  winningParty      VoteChoice?
  createdAt         DateTime      @default(now())
  resolvedAt        DateTime?

  job         Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  client      User           @relation("ClientDisputes", fields: [clientId], references: [id])
  freelancer  User           @relation("FreelancerDisputes", fields: [freelancerId], references: [id])
  initiator   User           @relation("InitiatedDisputes", fields: [initiatorId], references: [id])
  votes       DisputeVote[]
}

model DisputeVote {
  id         String     @id @default(cuid())
  disputeId  String
  voterId    String
  choice     VoteChoice
  reason     String?
  createdAt  DateTime   @default(now())

  dispute Dispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  voter   User    @relation(fields: [voterId], references: [id])

  @@unique([disputeId, voterId])
}
