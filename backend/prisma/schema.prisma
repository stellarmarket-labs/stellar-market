generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  FREELANCER
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum EscrowStatus {
  UNFUNDED
  FUNDED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum TransactionType {
  DEPOSIT
  RELEASE
  REFUND
  DISPUTE_PAYOUT
}

model User {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  email         String?  @unique
  username      String   @unique
  password      String?
  bio           String?
  avatarUrl     String?
  role                   UserRole  @default(FREELANCER)
  emailVerified          Boolean   @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpiry    DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  clientJobs     Job[]         @relation("ClientJobs")
  freelancerJobs Job[]         @relation("FreelancerJobs")
  applications   Application[]
  sentMessages   Message[]     @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")
  reviewsGiven   Review[]      @relation("ReviewsGiven")
  reviewsReceived Review[]     @relation("ReviewsReceived")
  skills          String[]
  transactionsFrom Transaction[] @relation("TransactionsFrom")
  transactionsTo   Transaction[] @relation("TransactionsTo")
  attachments      Attachment[]
}

model Job {
  id           String    @id @default(cuid())
  title        String
  description  String
  budget       Float
  category     String
  status       JobStatus @default(OPEN)
  clientId     String
  freelancerId String?
  contractJobId String?   @unique
  escrowStatus  EscrowStatus @default(UNFUNDED)
  skills       String[]
  deadline     DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  client       User          @relation("ClientJobs", fields: [clientId], references: [id])
  freelancer   User?         @relation("FreelancerJobs", fields: [freelancerId], references: [id])
  milestones   Milestone[]
  applications Application[]
  messages     Message[]
  reviews      Review[]
  transactions Transaction[]
  attachments  Attachment[]
}

model Milestone {
  id          String          @id @default(cuid())
  jobId       String
  title       String
  description String
  amount      Float
  status      MilestoneStatus @default(PENDING)
  order       Int
  onChainIndex Int?
  contractDeadline DateTime?
  dueDate     DateTime?
  createdAt   DateTime        @default(now())

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

model Application {
  id             String            @id @default(cuid())
  jobId             String
  freelancerId      String
  proposal          String
  bidAmount         Float
  estimatedDuration String
  status            ApplicationStatus @default(PENDING)
  createdAt      DateTime          @default(now())

  job        Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  freelancer User @relation(fields: [freelancerId], references: [id])

  @@unique([jobId, freelancerId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  jobId      String?
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])
  job      Job? @relation(fields: [jobId], references: [id])
}

model Review {
  id         String   @id @default(cuid())
  jobId      String
  reviewerId String
  revieweeId String
  rating     Int
  comment    String
  createdAt  DateTime @default(now())

  job      Job  @relation(fields: [jobId], references: [id])
  reviewer User @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewee User @relation("ReviewsReceived", fields: [revieweeId], references: [id])

  @@unique([jobId, reviewerId])
}

model Transaction {
  id           String          @id @default(cuid())
  jobId        String
  milestoneId  String?
  fromAddress  String
  toAddress    String
  amount       Float
  tokenAddress String
  txHash       String          @unique
  type         TransactionType
  createdAt    DateTime        @default(now())

  job       Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  milestone Milestone? @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  from      User       @relation("TransactionsFrom", fields: [fromAddress], references: [walletAddress])
  to        User       @relation("TransactionsTo", fields: [toAddress], references: [walletAddress])

  @@index([txHash])
  @@index([jobId])
  @@index([fromAddress])
  @@index([toAddress])
  @@index([type])
  @@index([createdAt])
}

model Attachment {
  id           String   @id @default(cuid())
  uploaderId   String
  jobId        String?
  disputeId    String?
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  createdAt    DateTime @default(now())

  uploader User  @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  job      Job?  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([uploaderId])
  @@index([jobId])
  @@index([disputeId])
  @@index([createdAt])
}
